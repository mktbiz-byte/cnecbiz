import { useState, useEffect } from 'react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Checkbox } from '@/components/ui/checkbox'
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { AlertCircle, Check, FileText, Download } from 'lucide-react'
import { useNavigate } from 'react-router-dom'
import { supabaseBiz, createCampaignInRegions } from '@/lib/supabaseClients'
import { generateAndDownloadQuotation, generateAndDownloadContract } from '@/lib/pdfGenerator'

const CampaignCreatePage = () => {
  const navigate = useNavigate()
  const [loading, setLoading] = useState(false)
  const [user, setUser] = useState(null)
  const [companyData, setCompanyData] = useState(null)
  const [step, setStep] = useState(1)
  
  const [formData, setFormData] = useState({
    // Package Selection
    package_type: 300000,
    
    // Region Selection
    regions: [],
    
    // Campaign Basic Info
    title: '',
    recruitment_count: 10,
    
    // Company/Brand Info
    brand_name: '',
    product_name: '',
    product_url: '',
    brand_identity: '',
    
    // Product Info
    required_dialogue: '',
    required_scenes: '',
    
    // Reference
    reference_urls: '',
    
    // Additional Info
    product_description: '',
    guidelines: ''
  })

  const [errors, setErrors] = useState({})

  const packages = [
    {
      value: 200000,
      name: 'Í∏∞Î≥∏Ìòï',
      price: '200,000Ïõê',
      features: ['ÏùºÎ∞ò ÌÄÑÎ¶¨Ìã∞ ÏßÄÏõêÏûê', 'ÏòÅÏÉÅ ÏàòÏ†ï Î∂àÍ∞Ä']
    },
    {
      value: 300000,
      name: 'Ïä§ÌÉ†Îã§Îìú',
      price: '300,000Ïõê',
      features: ['Ìñ•ÏÉÅÎêú ÌÄÑÎ¶¨Ìã∞ ÏßÄÏõêÏûê', 'ÏòÅÏÉÅ ÏàòÏ†ï 1Ìöå Í∞ÄÎä•'],
      popular: true
    },
    {
      value: 400000,
      name: 'ÌîÑÎ¶¨ÎØ∏ÏóÑ',
      price: '400,000Ïõê',
      features: ['ÏµúÍ≥† ÌÄÑÎ¶¨Ìã∞ ÏßÄÏõêÏûê', 'ÏòÅÏÉÅ ÏàòÏ†ï 1Ìöå Í∞ÄÎä•', 'Ïö∞ÏÑ† ÏßÄÏõê']
    },
    {
      value: 600000,
      name: '4Ï£º Ïó∞ÏÜç',
      price: '600,000Ïõê',
      features: ['Îß§Ï£º 1Í±¥Ïî© Ï¥ù 4Ï£ºÍ∞Ñ', 'ÌîÑÎ¶¨ÎØ∏ÏóÑ ÌÄÑÎ¶¨Ìã∞', 'ÏòÅÏÉÅ ÏàòÏ†ï 1Ìöå Í∞ÄÎä•', 'Ï†ÑÎã¥ Îß§ÎãàÏ†Ä']
    }
  ]

  const regions = [
    { code: 'japan', name: 'ÏùºÎ≥∏', flag: 'üáØüáµ' },
    { code: 'us', name: 'ÎØ∏Íµ≠', flag: 'üá∫üá∏' },
    { code: 'taiwan', name: 'ÎåÄÎßå', flag: 'üáπüáº' }
  ]

  useEffect(() => {
    // Check if user is logged in
    const storedUser = localStorage.getItem('cnecbiz_user')
    if (!storedUser) {
      alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§')
      navigate('/login')
      return
    }

    const parsedUser = JSON.parse(storedUser)
    setUser(parsedUser)

    // Fetch company data
    fetchCompanyData(parsedUser.id)
  }, [navigate])

  const fetchCompanyData = async (userId) => {
    try {
      if (!supabaseBiz) return

      const { data, error } = await supabaseBiz
        .from('companies')
        .select('*')
        .eq('id', userId)
        .single()

      if (error) throw error
      setCompanyData(data)
    } catch (error) {
      console.error('Error fetching company data:', error)
    }
  }

  const handleChange = (e) => {
    const { name, value } = e.target
    setFormData(prev => ({
      ...prev,
      [name]: value
    }))
    if (errors[name]) {
      setErrors(prev => ({
        ...prev,
        [name]: ''
      }))
    }
  }

  const handleRegionToggle = (regionCode) => {
    setFormData(prev => ({
      ...prev,
      regions: prev.regions.includes(regionCode)
        ? prev.regions.filter(r => r !== regionCode)
        : [...prev.regions, regionCode]
    }))
  }

  const validateStep1 = () => {
    const newErrors = {}

    if (formData.regions.length === 0) {
      newErrors.regions = 'ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅÏùò ÏßÄÏó≠ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî'
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const validateStep2 = () => {
    const newErrors = {}

    if (!formData.title.trim()) {
      newErrors.title = 'Ï∫†ÌéòÏù∏Î™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'
    }

    if (!formData.brand_name.trim()) {
      newErrors.brand_name = 'Î∏åÎûúÎìúÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'
    }

    if (!formData.product_name.trim()) {
      newErrors.product_name = 'Ï†úÌíàÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'
    }

    if (!formData.product_url.trim()) {
      newErrors.product_url = 'Ï†úÌíà URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const validateStep3 = () => {
    const newErrors = {}

    if (!formData.required_dialogue.trim()) {
      newErrors.required_dialogue = 'ÌïÑÏàò ÎåÄÏÇ¨Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'
    }

    if (!formData.required_scenes.trim()) {
      newErrors.required_scenes = 'ÌïÑÏàò Ïû•Î©¥ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleNext = () => {
    if (step === 1 && !validateStep1()) return
    if (step === 2 && !validateStep2()) return
    if (step === 3 && !validateStep3()) return
    
    setStep(step + 1)
  }

  const handleBack = () => {
    setStep(step - 1)
  }

  const handleSubmit = async () => {
    setLoading(true)

    try {
      if (!supabaseBiz) {
        alert('ÏÑúÎπÑÏä§ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§')
        return
      }

      // Prepare campaign data
      const campaignData = {
        company_id: user.id,
        package_type: formData.package_type,
        regions: formData.regions,
        title: formData.title,
        brand_name: formData.brand_name,
        product_name: formData.product_name,
        product_url: formData.product_url,
        brand_identity: formData.brand_identity,
        required_dialogue: formData.required_dialogue,
        required_scenes: formData.required_scenes,
        reference_urls: formData.reference_urls.split('\n').filter(url => url.trim()),
        product_description: formData.product_description,
        guidelines: formData.guidelines,
        recruitment_count: formData.recruitment_count,
        status: 'pending',
        created_at: new Date().toISOString()
      }

      // Save to BIZ database first
      const { data: bizCampaign, error: bizError } = await supabaseBiz
        .from('campaigns')
        .insert([campaignData])
        .select()
        .single()

      if (bizError) throw bizError

      // Create campaigns in selected regions
      const results = await createCampaignInRegions(campaignData, formData.regions)

      const successCount = results.filter(r => r.success).length
      const failCount = results.filter(r => !r.success).length

      if (successCount > 0) {
        alert(`Ï∫†ÌéòÏù∏Ïù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\nÏÑ±Í≥µ: ${successCount}Í∞ú ÏßÄÏó≠\nÏã§Ìå®: ${failCount}Í∞ú ÏßÄÏó≠`)
        
        // Generate documents
        if (companyData) {
          generateAndDownloadQuotation(formData, companyData)
          setTimeout(() => {
            generateAndDownloadContract(formData, companyData)
          }, 1000)
        }

        navigate('/dashboard')
      } else {
        alert('Ï∫†ÌéòÏù∏ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.')
      }
    } catch (error) {
      console.error('Campaign creation error:', error)
      alert(error.message || 'Ï∫†ÌéòÏù∏ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§')
    } finally {
      setLoading(false)
    }
  }

  const renderStep1 = () => (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-4">Ìå®ÌÇ§ÏßÄ ÏÑ†ÌÉù</h3>
        <RadioGroup
          value={formData.package_type.toString()}
          onValueChange={(value) => setFormData(prev => ({ ...prev, package_type: parseInt(value) }))}
        >
          <div className="grid md:grid-cols-2 gap-4">
            {packages.map((pkg) => (
              <Card
                key={pkg.value}
                className={`cursor-pointer transition-all ${
                  formData.package_type === pkg.value
                    ? 'border-2 border-blue-500 shadow-lg'
                    : 'hover:border-blue-300'
                } ${pkg.popular ? 'relative' : ''}`}
                onClick={() => setFormData(prev => ({ ...prev, package_type: pkg.value }))}
              >
                {pkg.popular && (
                  <div className="absolute -top-2 -right-2">
                    <span className="bg-blue-500 text-white px-3 py-1 rounded-full text-xs font-semibold">
                      Ïù∏Í∏∞
                    </span>
                  </div>
                )}
                <CardHeader>
                  <div className="flex items-center space-x-2">
                    <RadioGroupItem value={pkg.value.toString()} id={`pkg-${pkg.value}`} />
                    <div>
                      <CardTitle className="text-xl">{pkg.name}</CardTitle>
                      <CardDescription className="text-lg font-semibold text-blue-600">
                        {pkg.price}
                      </CardDescription>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  <ul className="space-y-2">
                    {pkg.features.map((feature, idx) => (
                      <li key={idx} className="flex items-start space-x-2 text-sm">
                        <Check className="h-4 w-4 text-green-500 flex-shrink-0 mt-0.5" />
                        <span>{feature}</span>
                      </li>
                    ))}
                  </ul>
                </CardContent>
              </Card>
            ))}
          </div>
        </RadioGroup>
      </div>

      <div>
        <h3 className="text-lg font-semibold mb-4">ÏßÑÌñâ ÏßÄÏó≠ ÏÑ†ÌÉù</h3>
        <div className="grid md:grid-cols-3 gap-4">
          {regions.map((region) => (
            <Card
              key={region.code}
              className={`cursor-pointer transition-all ${
                formData.regions.includes(region.code)
                  ? 'border-2 border-blue-500 bg-blue-50'
                  : 'hover:border-blue-300'
              }`}
              onClick={() => handleRegionToggle(region.code)}
            >
              <CardContent className="pt-6">
                <div className="flex items-center space-x-3">
                  <Checkbox
                    checked={formData.regions.includes(region.code)}
                    onCheckedChange={() => handleRegionToggle(region.code)}
                  />
                  <div className="text-4xl">{region.flag}</div>
                  <span className="text-lg font-semibold">{region.name}</span>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
        {errors.regions && (
          <Alert variant="destructive" className="mt-4">
            <AlertCircle className="h-4 w-4" />
            <AlertDescription>{errors.regions}</AlertDescription>
          </Alert>
        )}
      </div>

      <div className="bg-blue-50 p-4 rounded-lg">
        <p className="text-sm text-gray-700">
          <strong>ÏòàÏÉÅ Í∏àÏï°:</strong>{' '}
          {(formData.package_type * formData.regions.length).toLocaleString()}Ïõê
          {formData.regions.length > 1 && (
            <span className="text-gray-600">
              {' '}({formData.package_type.toLocaleString()}Ïõê √ó {formData.regions.length}Í∞ú ÏßÄÏó≠)
            </span>
          )}
        </p>
      </div>
    </div>
  )

  const renderStep2 = () => (
    <div className="space-y-6">
      <div className="space-y-2">
        <Label htmlFor="title">Ï∫†ÌéòÏù∏Î™Ö *</Label>
        <Input
          id="title"
          name="title"
          value={formData.title}
          onChange={handleChange}
          placeholder="Ïòà: Î∏îÎûëÎÑ§Ïù¥Ï≤ò 9Ïõî Ï∫†ÌéòÏù∏"
          className={errors.title ? 'border-red-500' : ''}
        />
        {errors.title && <p className="text-sm text-red-500">{errors.title}</p>}
      </div>

      <div className="space-y-2">
        <Label htmlFor="brand_name">Î∏åÎûúÎìúÎ™Ö *</Label>
        <Input
          id="brand_name"
          name="brand_name"
          value={formData.brand_name}
          onChange={handleChange}
          placeholder="Ïòà: Î∏îÎûëÎÑ§Ïù¥Ï≤ò"
          className={errors.brand_name ? 'border-red-500' : ''}
        />
        {errors.brand_name && <p className="text-sm text-red-500">{errors.brand_name}</p>}
      </div>

      <div className="space-y-2">
        <Label htmlFor="product_name">Ï†úÌíàÎ™Ö *</Label>
        <Input
          id="product_name"
          name="product_name"
          value={formData.product_name}
          onChange={handleChange}
          placeholder="Ïòà: ÎßàÍ∑∏ÎÜÄÎ¶¨ÏïÑ Ïï§ ÏÑ∏Î†àÎãàÌã∞ Î∑∞Ìã∞ ÌÅ¨Î¶º"
          className={errors.product_name ? 'border-red-500' : ''}
        />
        {errors.product_name && <p className="text-sm text-red-500">{errors.product_name}</p>}
      </div>

      <div className="space-y-2">
        <Label htmlFor="product_url">Ï†úÌíà URL *</Label>
        <Input
          id="product_url"
          name="product_url"
          value={formData.product_url}
          onChange={handleChange}
          placeholder="https://..."
          className={errors.product_url ? 'border-red-500' : ''}
        />
        {errors.product_url && <p className="text-sm text-red-500">{errors.product_url}</p>}
      </div>

      <div className="space-y-2">
        <Label htmlFor="brand_identity">Î∏åÎûúÎìú ÏïÑÏù¥Îç¥Ìã∞Ìã∞</Label>
        <Textarea
          id="brand_identity"
          name="brand_identity"
          value={formData.brand_identity}
          onChange={handleChange}
          placeholder="Î∏åÎûúÎìúÏùò ÌïµÏã¨ Í∞ÄÏπò, Ïª®ÏÖâ, ÌÉÄÍ≤ü Í≥†Í∞ù Îì±ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
          rows={4}
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="recruitment_count">Î™®Ïßë Ïù∏Ïõê</Label>
        <Input
          id="recruitment_count"
          name="recruitment_count"
          type="number"
          value={formData.recruitment_count}
          onChange={handleChange}
          min="1"
        />
      </div>
    </div>
  )

  const renderStep3 = () => (
    <div className="space-y-6">
      <div className="space-y-2">
        <Label htmlFor="required_dialogue">ÌïÑÏàò ÎåÄÏÇ¨ *</Label>
        <Textarea
          id="required_dialogue"
          name="required_dialogue"
          value={formData.required_dialogue}
          onChange={handleChange}
          placeholder="ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞Í∞Ä Î∞òÎìúÏãú Ïñ∏Í∏âÌï¥Ïïº ÌïòÎäî ÎåÄÏÇ¨Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
          rows={4}
          className={errors.required_dialogue ? 'border-red-500' : ''}
        />
        {errors.required_dialogue && <p className="text-sm text-red-500">{errors.required_dialogue}</p>}
      </div>

      <div className="space-y-2">
        <Label htmlFor="required_scenes">ÌïÑÏàò Ïû•Î©¥ *</Label>
        <Textarea
          id="required_scenes"
          name="required_scenes"
          value={formData.required_scenes}
          onChange={handleChange}
          placeholder="ÏòÅÏÉÅÏóê Î∞òÎìúÏãú Ìè¨Ìï®ÎêòÏñ¥Ïïº ÌïòÎäî Ïû•Î©¥ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
          rows={4}
          className={errors.required_scenes ? 'border-red-500' : ''}
        />
        {errors.required_scenes && <p className="text-sm text-red-500">{errors.required_scenes}</p>}
      </div>

      <div className="space-y-2">
        <Label htmlFor="reference_urls">Î†àÌçºÎü∞Ïä§ URL</Label>
        <Textarea
          id="reference_urls"
          name="reference_urls"
          value={formData.reference_urls}
          onChange={handleChange}
          placeholder="Ï∞∏Í≥†Ìï† ÏòÅÏÉÅ ÎßÅÌÅ¨Î•º Ìïú Ï§ÑÏóê ÌïòÎÇòÏî© ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
          rows={4}
        />
        <Alert>
          <AlertCircle className="h-4 w-4" />
          <AlertDescription>
            ‚ö†Ô∏è Î©îÌÉÄ Í¥ëÍ≥† ÏòÅÏÉÅ ÎßÅÌÅ¨Îäî Í¥ëÍ≥†Í∞Ä Ï¢ÖÎ£åÎêòÎ©¥ Î≥º Ïàò ÏóÜÏùÑ Ïàò ÏûàÏäµÎãàÎã§.
          </AlertDescription>
        </Alert>
      </div>

      <div className="space-y-2">
        <Label htmlFor="product_description">Ï†úÌíà ÏÑ§Î™Ö</Label>
        <Textarea
          id="product_description"
          name="product_description"
          value={formData.product_description}
          onChange={handleChange}
          placeholder="Ï†úÌíàÏóê ÎåÄÌïú ÏÉÅÏÑ∏ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
          rows={4}
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="guidelines">Í∞ÄÏù¥ÎìúÎùºÏù∏</Label>
        <Textarea
          id="guidelines"
          name="guidelines"
          value={formData.guidelines}
          onChange={handleChange}
          placeholder="ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞Í∞Ä ÏßÄÏºúÏïº Ìï† Í∞ÄÏù¥ÎìúÎùºÏù∏ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
          rows={4}
        />
      </div>
    </div>
  )

  const renderStep4 = () => (
    <div className="space-y-6">
      <Alert>
        <FileText className="h-4 w-4" />
        <AlertDescription>
          Ï∫†ÌéòÏù∏ ÏÉùÏÑ± Ïãú Í≤¨Ï†ÅÏÑúÏôÄ Í≥ÑÏïΩÏÑúÍ∞Ä ÏûêÎèôÏúºÎ°ú Îã§Ïö¥Î°úÎìúÎê©ÎãàÎã§.
        </AlertDescription>
      </Alert>

      <Card>
        <CardHeader>
          <CardTitle>Ï∫†ÌéòÏù∏ ÏöîÏïΩ</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <p className="text-sm text-gray-600">Ìå®ÌÇ§ÏßÄ</p>
            <p className="font-semibold">
              {packages.find(p => p.value === formData.package_type)?.name} (
              {formData.package_type.toLocaleString()}Ïõê)
            </p>
          </div>

          <div>
            <p className="text-sm text-gray-600">ÏßÑÌñâ ÏßÄÏó≠</p>
            <p className="font-semibold">
              {formData.regions.map(r => regions.find(reg => reg.code === r)?.name).join(', ')}
            </p>
          </div>

          <div>
            <p className="text-sm text-gray-600">Ï∫†ÌéòÏù∏Î™Ö</p>
            <p className="font-semibold">{formData.title}</p>
          </div>

          <div>
            <p className="text-sm text-gray-600">Î∏åÎûúÎìú/Ï†úÌíà</p>
            <p className="font-semibold">{formData.brand_name} - {formData.product_name}</p>
          </div>

          <div className="pt-4 border-t">
            <p className="text-sm text-gray-600">Ï¥ù Í∏àÏï°</p>
            <p className="text-2xl font-bold text-blue-600">
              {(formData.package_type * formData.regions.length).toLocaleString()}Ïõê
            </p>
          </div>
        </CardContent>
      </Card>
    </div>
  )

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <Card>
          <CardHeader>
            <CardTitle className="text-3xl">Ï∫†ÌéòÏù∏ ÏÉùÏÑ±</CardTitle>
            <CardDescription>
              Step {step} of 4
            </CardDescription>
            <div className="flex space-x-2 mt-4">
              {[1, 2, 3, 4].map((s) => (
                <div
                  key={s}
                  className={`flex-1 h-2 rounded ${
                    s <= step ? 'bg-blue-600' : 'bg-gray-200'
                  }`}
                />
              ))}
            </div>
          </CardHeader>
          <CardContent>
            {step === 1 && renderStep1()}
            {step === 2 && renderStep2()}
            {step === 3 && renderStep3()}
            {step === 4 && renderStep4()}

            <div className="flex justify-between mt-8">
              {step > 1 && (
                <Button variant="outline" onClick={handleBack}>
                  Ïù¥Ï†Ñ
                </Button>
              )}
              {step < 4 ? (
                <Button onClick={handleNext} className={step === 1 ? 'ml-auto' : ''}>
                  Îã§Ïùå
                </Button>
              ) : (
                <Button onClick={handleSubmit} disabled={loading} className="ml-auto">
                  {loading ? 'ÏÉùÏÑ± Ï§ë...' : 'Ï∫†ÌéòÏù∏ ÏÉùÏÑ±'}
                </Button>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}

export default CampaignCreatePage

