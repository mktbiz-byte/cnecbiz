-- =====================================================
-- CNEC BIZ - Terms Agreement System
-- =====================================================

-- =====================================================
-- 1. Terms Table
-- =====================================================
CREATE TABLE IF NOT EXISTS terms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Term Info
  type TEXT CHECK (type IN ('service', 'privacy', 'marketing', 'third_party', 'payment')) NOT NULL,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  
  -- Version
  version TEXT NOT NULL,
  is_required BOOLEAN DEFAULT true,
  is_active BOOLEAN DEFAULT true,
  
  -- Timestamps
  effective_date DATE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- 2. User Term Agreements Table
-- =====================================================
CREATE TABLE IF NOT EXISTS user_term_agreements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  term_id UUID REFERENCES terms(id) ON DELETE CASCADE,
  
  -- Agreement Info
  agreed BOOLEAN DEFAULT true,
  agreed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- IP and User Agent
  ip_address INET,
  user_agent TEXT,
  
  -- Unique constraint
  UNIQUE(user_id, term_id)
);

-- =====================================================
-- 3. Insert Default Terms
-- =====================================================

-- Service Terms
INSERT INTO terms (type, title, content, version, is_required, effective_date) VALUES
('service', 'ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€', '
ì œ1ì¡° (ëª©ì )
ì´ ì•½ê´€ì€ CNEC BIZ(ì´í•˜ "íšŒì‚¬")ê°€ ì œê³µí•˜ëŠ” ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… í”Œëž«í¼ ì„œë¹„ìŠ¤(ì´í•˜ "ì„œë¹„ìŠ¤")ì˜ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ íšŒì‚¬ì™€ ì´ìš©ìž ê°„ì˜ ê¶Œë¦¬, ì˜ë¬´ ë° ì±…ìž„ì‚¬í•­, ê¸°íƒ€ í•„ìš”í•œ ì‚¬í•­ì„ ê·œì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.

ì œ2ì¡° (ì •ì˜)
1. "ì„œë¹„ìŠ¤"ëž€ íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… ìº íŽ˜ì¸ ê´€ë¦¬ í”Œëž«í¼ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
2. "ì´ìš©ìž"ëž€ ì´ ì•½ê´€ì— ë”°ë¼ íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ê¸°ì—… íšŒì›ì„ ë§í•©ë‹ˆë‹¤.
3. "ìº íŽ˜ì¸"ì´ëž€ ì´ìš©ìžê°€ ì¸í”Œë£¨ì–¸ì„œë¥¼ í†µí•´ ì§„í–‰í•˜ëŠ” ë§ˆì¼€íŒ… í™œë™ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ì œ3ì¡° (ì•½ê´€ì˜ íš¨ë ¥ ë° ë³€ê²½)
1. ì´ ì•½ê´€ì€ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ê³ ìž í•˜ëŠ” ëª¨ë“  ì´ìš©ìžì—ê²Œ ê·¸ íš¨ë ¥ì´ ë°œìƒí•©ë‹ˆë‹¤.
2. íšŒì‚¬ëŠ” í•„ìš”í•œ ê²½ìš° ê´€ë ¨ ë²•ë ¹ì„ ìœ„ë°°í•˜ì§€ ì•ŠëŠ” ë²”ìœ„ì—ì„œ ì´ ì•½ê´€ì„ ë³€ê²½í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

ì œ4ì¡° (ì„œë¹„ìŠ¤ì˜ ì œê³µ)
1. íšŒì‚¬ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤:
   - ì¸í”Œë£¨ì–¸ì„œ ë§¤ì¹­ ë° ìº íŽ˜ì¸ ê´€ë¦¬
   - ì½˜í…ì¸  ê°€ì´ë“œ ìƒì„± ë° ë²ˆì—­
   - ì„±ê³¼ ë¶„ì„ ë° ë³´ê³ ì„œ
2. ì„œë¹„ìŠ¤ëŠ” ì—°ì¤‘ë¬´íœ´, 1ì¼ 24ì‹œê°„ ì œê³µí•¨ì„ ì›ì¹™ìœ¼ë¡œ í•©ë‹ˆë‹¤.

ì œ5ì¡° (ì´ìš©ìžì˜ ì˜ë¬´)
1. ì´ìš©ìžëŠ” ì„œë¹„ìŠ¤ ì´ìš© ì‹œ ë‹¤ìŒ í–‰ìœ„ë¥¼ í•˜ì—¬ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤:
   - íƒ€ì¸ì˜ ì •ë³´ ë„ìš©
   - í—ˆìœ„ ì •ë³´ ì œê³µ
   - ì €ìž‘ê¶Œ ë“± íƒ€ì¸ì˜ ê¶Œë¦¬ ì¹¨í•´
   - ë¶ˆë²•ì ì´ê±°ë‚˜ ë¶€ì ì ˆí•œ ì½˜í…ì¸  ìš”ì²­

ì œ6ì¡° (ê²°ì œ ë° í™˜ë¶ˆ)
1. ì„œë¹„ìŠ¤ ì´ìš©ë£ŒëŠ” ì‚¬ì „ì— ê³µì§€ëœ ìš”ê¸ˆí‘œì— ë”°ë¦…ë‹ˆë‹¤.
2. í™˜ë¶ˆì€ íšŒì‚¬ì˜ í™˜ë¶ˆ ì •ì±…ì— ë”°ë¼ ì²˜ë¦¬ë©ë‹ˆë‹¤.

ì œ7ì¡° (ë©´ì±…ì¡°í•­)
1. íšŒì‚¬ëŠ” ì²œìž¬ì§€ë³€, ì „ìŸ, ê¸°íƒ€ ì´ì— ì¤€í•˜ëŠ” ë¶ˆê°€í•­ë ¥ìœ¼ë¡œ ì¸í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•  ìˆ˜ ì—†ëŠ” ê²½ìš°ì—ëŠ” ì„œë¹„ìŠ¤ ì œê³µì— ê´€í•œ ì±…ìž„ì´ ë©´ì œë©ë‹ˆë‹¤.

ì œ8ì¡° (ë¶„ìŸ í•´ê²°)
1. ì´ ì•½ê´€ì— ëª…ì‹œë˜ì§€ ì•Šì€ ì‚¬í•­ì€ ê´€ë ¨ ë²•ë ¹ ë° ìƒê´€ë¡€ì— ë”°ë¦…ë‹ˆë‹¤.
2. ì„œë¹„ìŠ¤ ì´ìš©ìœ¼ë¡œ ë°œìƒí•œ ë¶„ìŸì— ëŒ€í•´ ì†Œì†¡ì´ ì œê¸°ë  ê²½ìš° íšŒì‚¬ì˜ ë³¸ì‚¬ ì†Œìž¬ì§€ë¥¼ ê´€í• í•˜ëŠ” ë²•ì›ì„ ê´€í•  ë²•ì›ìœ¼ë¡œ í•©ë‹ˆë‹¤.

ë¶€ì¹™
ì´ ì•½ê´€ì€ 2025ë…„ 1ì›” 1ì¼ë¶€í„° ì‹œí–‰í•©ë‹ˆë‹¤.
', '1.0', true, '2025-01-01');

-- Privacy Policy
INSERT INTO terms (type, title, content, version, is_required, effective_date) VALUES
('privacy', 'ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨', '
CNEC BIZ(ì´í•˜ "íšŒì‚¬")ëŠ” ì´ìš©ìžì˜ ê°œì¸ì •ë³´ë¥¼ ì¤‘ìš”ì‹œí•˜ë©°, ê°œì¸ì •ë³´ ë³´í˜¸ë²• ë“± ê´€ë ¨ ë²•ë ¹ì„ ì¤€ìˆ˜í•˜ê³  ìžˆìŠµë‹ˆë‹¤.

ì œ1ì¡° (ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ í•­ëª© ë° ë°©ë²•)
1. ìˆ˜ì§‘ í•­ëª©:
   - í•„ìˆ˜: íšŒì‚¬ëª…, ì‚¬ì—…ìžë“±ë¡ë²ˆí˜¸, ë‹´ë‹¹ìžëª…, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸
   - ì„ íƒ: ë§ˆì¼€íŒ… ìˆ˜ì‹  ë™ì˜ ì—¬ë¶€
2. ìˆ˜ì§‘ ë°©ë²•: íšŒì›ê°€ìž…, ì„œë¹„ìŠ¤ ì´ìš© ê³¼ì •ì—ì„œ ìˆ˜ì§‘

ì œ2ì¡° (ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ë° ì´ìš© ëª©ì )
1. íšŒì› ê´€ë¦¬: ë³¸ì¸ í™•ì¸, ì„œë¹„ìŠ¤ ì œê³µ
2. ì„œë¹„ìŠ¤ ì œê³µ: ìº íŽ˜ì¸ ê´€ë¦¬, ê²°ì œ ì²˜ë¦¬
3. ë§ˆì¼€íŒ… í™œìš©: ì‹ ê·œ ì„œë¹„ìŠ¤ ì•ˆë‚´ (ë™ì˜ ì‹œ)

ì œ3ì¡° (ê°œì¸ì •ë³´ì˜ ë³´ìœ  ë° ì´ìš© ê¸°ê°„)
1. íšŒì› íƒˆí‡´ ì‹œê¹Œì§€ ë³´ìœ 
2. ê´€ë ¨ ë²•ë ¹ì— ë”°ë¼ ì¼ì • ê¸°ê°„ ë³´ê´€:
   - ê³„ì•½ ë˜ëŠ” ì²­ì•½ì² íšŒ ê¸°ë¡: 5ë…„
   - ëŒ€ê¸ˆê²°ì œ ë° ìž¬í™” ê³µê¸‰ ê¸°ë¡: 5ë…„
   - ì†Œë¹„ìž ë¶ˆë§Œ ë˜ëŠ” ë¶„ìŸì²˜ë¦¬ ê¸°ë¡: 3ë…„

ì œ4ì¡° (ê°œì¸ì •ë³´ì˜ ì œ3ìž ì œê³µ)
íšŒì‚¬ëŠ” ì›ì¹™ì ìœ¼ë¡œ ì´ìš©ìžì˜ ê°œì¸ì •ë³´ë¥¼ ì œ3ìžì—ê²Œ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ë‹¤ìŒì˜ ê²½ìš°ëŠ” ì˜ˆì™¸ë¡œ í•©ë‹ˆë‹¤:
1. ì´ìš©ìžê°€ ì‚¬ì „ì— ë™ì˜í•œ ê²½ìš°
2. ë²•ë ¹ì˜ ê·œì •ì— ì˜ê±°í•˜ê±°ë‚˜, ìˆ˜ì‚¬ ëª©ì ìœ¼ë¡œ ë²•ë ¹ì— ì •í•´ì§„ ì ˆì°¨ì™€ ë°©ë²•ì— ë”°ë¼ ìˆ˜ì‚¬ê¸°ê´€ì˜ ìš”êµ¬ê°€ ìžˆëŠ” ê²½ìš°

ì œ5ì¡° (ì´ìš©ìžì˜ ê¶Œë¦¬)
1. ì´ìš©ìžëŠ” ì–¸ì œë“ ì§€ ìžì‹ ì˜ ê°œì¸ì •ë³´ë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
2. ì´ìš©ìžëŠ” ì–¸ì œë“ ì§€ íšŒì› íƒˆí‡´ë¥¼ í†µí•´ ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜ë¥¼ ì² íšŒí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

ì œ6ì¡° (ê°œì¸ì •ë³´ ë³´í˜¸ì±…ìž„ìž)
íšŒì‚¬ëŠ” ì´ìš©ìžì˜ ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•˜ê³  ê°œì¸ì •ë³´ì™€ ê´€ë ¨í•œ ë¶ˆë§Œì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•˜ì—¬ ì•„ëž˜ì™€ ê°™ì´ ê°œì¸ì •ë³´ ë³´í˜¸ì±…ìž„ìžë¥¼ ì§€ì •í•˜ê³  ìžˆìŠµë‹ˆë‹¤.
- ì´ë©”ì¼: privacy@cnecbiz.com
- ì „í™”: 02-1234-5678

ë¶€ì¹™
ì´ ë°©ì¹¨ì€ 2025ë…„ 1ì›” 1ì¼ë¶€í„° ì‹œí–‰í•©ë‹ˆë‹¤.
', '1.0', true, '2025-01-01');

-- Marketing Agreement
INSERT INTO terms (type, title, content, version, is_required, effective_date) VALUES
('marketing', 'ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜', '
CNEC BIZëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë§ˆì¼€íŒ… ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤:

1. ì œê³µ ë‚´ìš©:
   - ì‹ ê·œ ì„œë¹„ìŠ¤ ë° ì´ë²¤íŠ¸ ì•ˆë‚´
   - í”„ë¡œëª¨ì…˜ ë° í• ì¸ ì •ë³´
   - ì„œë¹„ìŠ¤ ê°œì„  ë° ì—…ë°ì´íŠ¸ ì†Œì‹

2. ì œê³µ ë°©ë²•:
   - ì´ë©”ì¼
   - SMS/MMS
   - ì•± í‘¸ì‹œ ì•Œë¦¼

3. ì² íšŒ ë°©ë²•:
   - ë§ˆì´íŽ˜ì´ì§€ì—ì„œ ì–¸ì œë“ ì§€ ìˆ˜ì‹  ê±°ë¶€ ê°€ëŠ¥
   - ìˆ˜ì‹  ê±°ë¶€ ì‹œì—ë„ ì„œë¹„ìŠ¤ ì´ìš©ì—ëŠ” ì˜í–¥ì´ ì—†ìŠµë‹ˆë‹¤

ë³¸ ë™ì˜ëŠ” ì„ íƒì‚¬í•­ì´ë©°, ë™ì˜í•˜ì§€ ì•Šì•„ë„ ì„œë¹„ìŠ¤ ì´ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
', '1.0', false, '2025-01-01');

-- Third Party Agreement
INSERT INTO terms (type, title, content, version, is_required, effective_date) VALUES
('third_party', 'ì œ3ìž ì •ë³´ ì œê³µ ë™ì˜', '
CNEC BIZëŠ” ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì´ ì´ìš©ìžì˜ ê°œì¸ì •ë³´ë¥¼ ì œ3ìžì—ê²Œ ì œê³µí•©ë‹ˆë‹¤:

1. ì œê³µë°›ëŠ” ìž: ì œíœ´ ì¸í”Œë£¨ì–¸ì„œ, ê²°ì œ ëŒ€í–‰ì‚¬
2. ì œê³µ ëª©ì : ìº íŽ˜ì¸ ì§„í–‰, ê²°ì œ ì²˜ë¦¬
3. ì œê³µ í•­ëª©: íšŒì‚¬ëª…, ë‹´ë‹¹ìžëª…, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸
4. ë³´ìœ  ë° ì´ìš© ê¸°ê°„: ìº íŽ˜ì¸ ì¢…ë£Œ ì‹œê¹Œì§€

ë³¸ ë™ì˜ëŠ” ì„ íƒì‚¬í•­ì´ë‚˜, ë™ì˜í•˜ì§€ ì•Šì„ ê²½ìš° ì¼ë¶€ ì„œë¹„ìŠ¤ ì´ìš©ì´ ì œí•œë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
', '1.0', false, '2025-01-01');

-- Payment Terms
INSERT INTO terms (type, title, content, version, is_required, effective_date) VALUES
('payment', 'ê²°ì œ ì•½ê´€', '
ì œ1ì¡° (ê²°ì œ ìˆ˜ë‹¨)
1. ì‹ ìš©ì¹´ë“œ (Stripe)
2. ê³„ì¢Œì´ì²´
3. í¬ì¸íŠ¸

ì œ2ì¡° (ê²°ì œ ê¸ˆì•¡)
1. ëª¨ë“  ê¸ˆì•¡ì€ ë¶€ê°€ì„¸ ë³„ë„ìž…ë‹ˆë‹¤.
2. ê³µê¸‰ê°€ì•¡ + ë¶€ê°€ì„¸(10%) = ì´ ê²°ì œ ê¸ˆì•¡

ì œ3ì¡° (í™˜ë¶ˆ ì •ì±…)
1. ìº íŽ˜ì¸ ì‹œìž‘ ì „: ì „ì•¡ í™˜ë¶ˆ
2. ìº íŽ˜ì¸ ì§„í–‰ ì¤‘: ì§„í–‰ë¥ ì— ë”°ë¼ ë¶€ë¶„ í™˜ë¶ˆ
3. ìº íŽ˜ì¸ ì™„ë£Œ í›„: í™˜ë¶ˆ ë¶ˆê°€

ì œ4ì¡° (ì„¸ê¸ˆê³„ì‚°ì„œ)
1. ê³„ì¢Œì´ì²´ ê²°ì œ ì‹œ ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ê°€ëŠ¥
2. ë°œí–‰ ìš”ì²­ í›„ ì˜ì—…ì¼ ê¸°ì¤€ 2-3ì¼ ë‚´ ì´ë©”ì¼ ë°œì†¡

ì œ5ì¡° (í¬ì¸íŠ¸)
1. 1í¬ì¸íŠ¸ = 1ì›
2. ìœ íš¨ê¸°ê°„: ì¶©ì „ì¼ë¡œë¶€í„° 5ë…„
3. í™˜ë¶ˆ ì‹œ ìˆ˜ìˆ˜ë£Œ 10% ì°¨ê°

ë³¸ ì•½ê´€ì— ë™ì˜í•˜ì‹œë©´ ê²°ì œë¥¼ ì§„í–‰í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
', '1.0', true, '2025-01-01');

-- =====================================================
-- 4. Indexes
-- =====================================================
CREATE INDEX IF NOT EXISTS idx_terms_type ON terms(type);
CREATE INDEX IF NOT EXISTS idx_terms_is_active ON terms(is_active);
CREATE INDEX IF NOT EXISTS idx_user_term_agreements_user_id ON user_term_agreements(user_id);
CREATE INDEX IF NOT EXISTS idx_user_term_agreements_term_id ON user_term_agreements(term_id);

-- =====================================================
-- 5. Triggers
-- =====================================================
CREATE TRIGGER update_terms_updated_at BEFORE UPDATE ON terms
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- =====================================================
-- 6. RLS Policies
-- =====================================================

-- Terms
ALTER TABLE terms ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active terms"
  ON terms FOR SELECT
  USING (is_active = true);

-- User Term Agreements
ALTER TABLE user_term_agreements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own agreements"
  ON user_term_agreements FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own agreements"
  ON user_term_agreements FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- Admin Policies
CREATE POLICY "Admin can manage terms"
  ON terms FOR ALL
  USING (auth.jwt() ->> 'email' = 'admin@cnecbiz.com');

CREATE POLICY "Admin can view all agreements"
  ON user_term_agreements FOR SELECT
  USING (auth.jwt() ->> 'email' = 'admin@cnecbiz.com');

-- =====================================================
-- Success Message
-- =====================================================
DO $$
BEGIN
  RAISE NOTICE 'âœ… Terms Agreement System Setup Complete!';
  RAISE NOTICE 'ðŸ“‹ Terms table created with 5 default terms';
  RAISE NOTICE 'âœ“ User agreements table created';
  RAISE NOTICE 'ðŸ”’ RLS policies applied';
  RAISE NOTICE 'ðŸŽ‰ Ready to use!';
END $$;

